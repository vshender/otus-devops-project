---
- name: Run GitLab
  hosts: gitlab
  become: true
  gather_facts: false

  vars:
    gitlab_dir: /srv/gitlab
    gitlab_host: http://{{ ansible_host }}

  tasks:
    - name: Create GitLab directories
      file:
        path: "{{ gitlab_dir }}/{{ item }}"
        state: directory
      with_items:
        - config
        - data
        - logs
      tags: run_gitlab

    - name: Run GitLab
      docker_container:
        name: gitlab
        hostname: gitlab.example.com
        state: started
        restart: false
        restart_policy: always
        env:
          GITLAB_OMNIBUS_CONFIG: "external_url '{{ gitlab_host }}'"
        ports:
          - "80:80"
          - "443:443"
          - "2222:22"
        volumes:
          - "{{ gitlab_dir }}/config:/etc/gitlab"
          - "{{ gitlab_dir }}/logs:/var/log/gitlab"
          - "{{ gitlab_dir }}/data:/var/opt/gitlab"
        image: gitlab/gitlab-ce:latest
      register: run_gitlab
      tags: run_gitlab

    - name: Obtain GitLab password
      community.docker.docker_container_exec:
        container: gitlab
        command: grep 'Password:' /etc/gitlab/initial_root_password
      retries: 10
      delay: 5
      changed_when: false
      register: gitlab_password_output
      until: gitlab_password_output.rc == 0
      tags: run_gitlab

    - name: Extract GitLab password
      set_fact:
        gitlab_password: "{{ gitlab_password_output.stdout_lines.0 | split | last }}"
      tags: run_gitlab

    - name: Show GitLab password
      debug:
        msg: "GitLab credentials for the first login: username: root, password: {{ gitlab_password }}"
      tags: run_gitlab
